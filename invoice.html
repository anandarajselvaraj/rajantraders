<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Professional Invoice</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;padding:10px}

/* SCALE */
.invoice-wrapper{
    transform:scale(0.8);
    transform-origin:top left;
    width:125%;
}

.invoice{max-width:1100px;margin:auto;background:#fff;padding:15px}

/* HEADER */
.header{
    display:flex;
    align-items:center;
    gap:15px;
    border-bottom:1px solid #999;
    padding-bottom:8px;
}
.logo img{width:70px}
.company{text-align:center;flex:1}

/* HISTORY */
.history-row{
    text-align:right;
    margin:8px 0;
}

/* CONTROLS */
.controls{
    text-align:center;
    margin:8px 0;
}
button{padding:5px 8px;margin:3px}

/* CUSTOMER + DATE */
.cust-date{
    display:flex;
    gap:15px;
    margin:10px 0;
}
.cust-date div{flex:1}
.cust-date label{
    font-weight:bold;
    font-size:13px;
    display:block;
    margin-bottom:3px;
}

/* TABLE */
.table-wrap{max-height:340px;overflow:auto;border:1px solid #999}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:14px}
th,td{border:1px solid #999;padding:4px;text-align:center}
thead th{position:sticky;top:0;background:#eee}
input,select,textarea{
    width:100%;
    box-sizing:border-box;
    border:1px solid #999;
    padding:6px;
    font-size:14px;
}
textarea{min-height:35px;resize:vertical;text-align:left}
input[readonly]{background:#f1f1f1}

/* COLUMN WIDTHS */
th:nth-child(1),td:nth-child(1){width:30px}
th:nth-child(2),td:nth-child(2){width:35px}
th:nth-child(4),td:nth-child(4){width:60px}
th:nth-child(5),td:nth-child(5){width:60px}
th:nth-child(6),td:nth-child(6){width:75px}
th:nth-child(7),td:nth-child(7){width:85px}
.del-btn{font-size:12px;padding:2px 5px}

/* SUMMARY */
.summary{
    max-width:360px;
    margin-left:auto;
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:6px;
}
.summary div{
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.summary span{
    flex:1;
    text-align:right;
    font-weight:bold;
    padding-right:8px;
}
.summary input{width:120px;text-align:right}
</style>
</head>

<body>

<div class="invoice-wrapper">
<div class="invoice" id="invoice">

<!-- HEADER -->
<div class="header">
  <div class="logo"><img src="logo.png"></div>
  <div class="company">
    <h2>Classic Petroleum</h2>
    <p>98, Radio Park East Street, Dadagapatty Gate, Salem-636006, Tamil Nadu, India</p>
  </div>
</div>

<!-- HISTORY ABOVE BUTTONS -->
<div class="history-row">
  <select id="history" onchange="loadHistory(this.value)">
    <option value="">Load from History</option>
  </select>
</div>

<!-- BUTTONS -->
<div class="controls">
  <button onclick="addRow()">‚ûï Add Row</button>
  <button onclick="saveInvoice()">üíæ Save</button>
  <button onclick="loadInvoice()">üîÑ Load Last</button>
  <button onclick="downloadPDF()">üìÑ PDF</button>
  <button onclick="markDelete()">üóë Mark/Unmark Delete</button>
  <button onclick="deleteMarked()">‚ùå Delete Marked</button>
  <button onclick="exportExcel()">üìä Excel</button>
</div>


<!-- CUSTOMER + DATE BELOW BUTTONS -->
<div class="cust-date">
  <div>
    <label>Customer Name</label>
    <input id="customer" placeholder="Customer Name">
  </div>
  <div>
    <label>Date</label>
    <input type="date" id="invDate">
  </div>
</div>

<!-- TABLE -->
<div class="table-wrap">
<table>
<thead>
<tr>
<th>‚ùå</th><th>S#</th><th>Particulars</th>
<th>Qty</th><th>Unit</th><th>Rate</th><th>Total</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- SUMMARY -->
<div class="summary">
<div><span>Sub Total</span><input id="sub" readonly></div>
<div><span>Tax %</span><input id="tax" value="18" oninput="calc()"></div>
<div><span>Tax Amt</span><input id="taxAmt" readonly></div>
<div><span>Grand Total</span><input id="grand" readonly></div>
<div><span>Credit</span><input id="credit" oninput="calcBal()"></div>
<div><span>Debit</span><input id="debit" readonly></div>
</div>

</div>
</div>

<script>
const tbody=document.getElementById("tbody")
const customer = document.getElementById("customer");
const invDate = document.getElementById("invDate");
const credit = document.getElementById("credit");
const debit = document.getElementById("debit");
const sub = document.getElementById("sub");
const tax = document.getElementById("tax");
const taxAmt = document.getElementById("taxAmt");
const grand = document.getElementById("grand");
const history = document.getElementById("history");
invDate.value=new Date().toISOString().split("T")[0]

function addRow(d={}){
 let tr=document.createElement("tr")
 tr.innerHTML=`
 <td><button class="del-btn" onclick="this.closest('tr').remove();renumber()">‚úñ</button></td>
 <td class="sl"></td>
 <td><textarea>${d.p||""}</textarea></td>
 <td><input class="qty" oninput="calc()" value="${d.q||""}"></td>
 <td><select><option>LTR</option><option>KG</option></select></td>
 <td><input class="rate" oninput="calc()" value="${d.r||""}"></td>
 <td><input class="total" readonly></td>`
 tbody.appendChild(tr); renumber()
}

function renumber(){
 [...tbody.querySelectorAll(".sl")].forEach((e,i)=>e.textContent=i+1)
 calc()
}

function calc(){
 let s=0
 tbody.querySelectorAll("tr").forEach(r=>{
   let q=r.querySelector(".qty").value||0
   let rt=r.querySelector(".rate").value||0
   let t=q*rt
   r.querySelector(".total").value=t.toFixed(2)
   s+=t
 })
 sub.value=s.toFixed(2)
 taxAmt.value=(s*(tax.value||0)/100).toFixed(2)
 grand.value=(+sub.value + +taxAmt.value).toFixed(2)
 calcBal()
}

function calcBal(){
 let d=grand.value-(credit.value||0)
 debit.value=d>0?d.toFixed(2):"0.00"
}

/* SAVE WITH CUSTOMER + TIMESTAMP */
function saveInvoice(){
 if(!customer.value) return alert("Enter customer name")
 const n=new Date()
 const ts=`${String(n.getDate()).padStart(2,'0')}-${n.toLocaleString('en',{month:'short'})}-${String(n.getFullYear()).slice(-2)}-${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`
 const key=`${customer.value}-${ts}`

 let data={customer:customer.value,date:invDate.value,credit:credit.value,deleted:false,
 rows:[...tbody.children].map(r=>({p:r.cells[2].firstChild.value,q:r.querySelector(".qty").value,r:r.querySelector(".rate").value}))}

 let h=JSON.parse(localStorage.getItem("history")||"{}")
 h[key]=data
 localStorage.setItem("history",JSON.stringify(h))
 loadHistoryOptions()
}

function loadHistory(k){
 if(!k)return
 let h=JSON.parse(localStorage.getItem("history"))
 let d=h[k]
 customer.value=d.customer
 invDate.value=d.date
 credit.value=d.credit
 tbody.innerHTML=""
 d.rows.forEach(r=>addRow(r))
 calc()
}

function loadInvoice(){
 let h=JSON.parse(localStorage.getItem("history")||"{}")
 let k=Object.keys(h).pop()
 if(k)loadHistory(k)
}

function loadHistoryOptions(){
 history.innerHTML='<option value="">Load from History</option>'
 let h=JSON.parse(localStorage.getItem("history")||"{}")
 Object.keys(h).forEach(k=>{
   let o=document.createElement("option")
   o.value=k
   o.textContent=h[k].deleted?`${k} ‚ùå`:k
   history.appendChild(o)
 })
}
loadHistoryOptions()

function markDelete(){
 let k=history.value
 if(!k)return
 let h=JSON.parse(localStorage.getItem("history"))
 h[k].deleted=!h[k].deleted
 localStorage.setItem("history",JSON.stringify(h))
 loadHistoryOptions()
}

function deleteMarked(){
 let h=JSON.parse(localStorage.getItem("history"))
 Object.keys(h).forEach(k=>{if(h[k].deleted)delete h[k]})
 localStorage.setItem("history",JSON.stringify(h))
 loadHistoryOptions()
}

function downloadPDF(){
 html2canvas(invoice).then(c=>{
  const pdf=new jspdf.jsPDF("p","mm","a4")
  pdf.addImage(c.toDataURL(),"PNG",10,10,190,c.height*190/c.width)
  pdf.save("invoice.pdf")
 })
}

function exportExcel(){
 let wb=XLSX.utils.book_new()
 let data=[["Sl","Particulars","Qty","Rate","Total"]]
 tbody.querySelectorAll("tr").forEach(r=>{
   data.push([r.querySelector(".sl").textContent,r.cells[2].firstChild.value,r.querySelector(".qty").value,r.querySelector(".rate").value,r.querySelector(".total").value])
 })
 let ws=XLSX.utils.aoa_to_sheet(data)
 XLSX.utils.book_append_sheet(wb,ws,"Invoice")
 XLSX.writeFile(wb,"invoice.xlsx")
}

new Sortable(tbody,{animation:150,onEnd:renumber})
addRow()
</script>

</body>
</html>
